# Internationalization (i18n)

i18n in Python enables multi-language support for programs. The following demonstrates using the vnpy package on Windows systems.


## Marking Strings

Mark strings that need translation in the source code, as shown in the following code:

```python
from .locale import _

output(_("Parameter optimization space: {}").format(len(settings)))
```

Please note:
 - Don't forget to load the _ function
 - Use format syntax instead of f-string


## Creating pot files

In the command line, call pygettext.py in the Tools\i18n folder of the Python environment to scan all Python files in the module, writing all marked strings to the specified pot template file, as shown in the following code:

```python
python "your_python_environment_path"\Tools\i18n\pygettext.py -o vnpy\trader\locale\vnpy.pot vnpy\trader\*.py vnpy\trader\ui\*.py
```
Where -o is followed by the path to the pot file to be generated, "vnpy\trader\*.py" is an example of scanning all Python files in the specified folder.


## Creating po files

Using English as an example, create an /en/LC_MESSAGES folder under the locale folder, copy the generated pot file to this folder and change the extension to po.

**Modify the charset at the top of the po file to UTF-8**, then translate the msgid in the template, as shown in the following code:

Before modification:
```
#: vnpy/trader/optimize.py:62
msgid "Range parameter added successfully, quantity {}"
msgstr ""
```

After modification:

```
#: vnpy/trader/optimize.py:62
msgid "Range parameter added successfully, quantity {}"
msgstr "Range parameter added successfully, quantity {}"
```

Please note the language conversion of punctuation marks.


## Generating mo files

In the command line, call msgfmt.py in the Tools\i18n folder of the Python environment to convert the po file to a binary mo file, as shown in the following code:

```python
python "your_python_environment_path"\Tools\i18n\msgfmt.py -o vnpy\trader\locale\en\LC_MESSAGES\vnpy.mo vnpy\trader\locale\en\LC_MESSAGES\vnpy
```
Where -o is followed by the path to generate the mo file, and the last is the path to the po file (without extension)


## Packaging

During packaging, please add ```*.mo``` to the MANIFEST.in file so that mo files are not ignored during installation


## Usage

Configure the system language and use the software normally. At runtime, the program will read the configured system language and try to find the corresponding language translation package.



# Internationalization (i18n)

This document outlines the i18n process. Using the steps in this guide, multi-language support can be incorporated into VeighNa using standard Python conventions

References:
* https://docs.python.org/3.10/library/i18n.html
* https://simpleit.rocks/python/how-to-translate-a-python-project-with-gettext-the-easy-way/
* https://www.mattlayman.com/blog/2015/i18n/

## prerequisites

* [gettext](https://www.gnu.org/software/gettext/)
  - Linux/Mac: `brew install gettext`
  - Windows: https://mlocati.github.io/articles/gettext-iconv-windows.html (or similar)


## mark messages

The first step is to *mark* message strings for translation. We do this by wrapping the string with a special function. Example:

```python
output("优化参数组合为空，请检查")
```

becomes 

```python
from .locale import _

output(_("优化参数组合为空，请检查"))
```

or, a parameterised message 

```python
output("参数优化空间：{}".format(len(settings)))
```

becomes

```python
from .locale import _

output(_("参数优化空间：{}").format(len(settings)))
```

as unfortunately f-strings are not supported. One way to search for Chinese characters is to use the regex `\p{InCJK_UNIFIED_IDEOGRAPHS}` 

## template files

Once all the messages are marked, we run `xgettext` to extract the translatable strings into a message template file 

```shell
xgettext -o vnpy/trader/locale/base.pot `find ./vnpy -name "*.py"`
```

## individual language files

We then create individual language files, by copying the template. So for English and Spanish

```shell
mkdir -p vnpy/trader/locale/{en, es}/LC_MESSAGES
cp vnpy/trader/locale/vnpy.pot vnpy/trader/locale/en/LC_MESSAGES/vnpy.po
cp vnpy/trader/locale/vnpy.pot vnpy/trader/locale/es/LC_MESSAGES/vnpy.po
```

Then edit the .po files to add the translated text, updating the `msgstr` attributes. So for English (`vnpy/trader/locale/en/LC_MESSAGES/vnpy.po`):

```
#: vnpy/trader/optimize.py:45
msgid "固定参数添加成功"
msgstr ""

#: vnpy/trader/optimize.py:48
msgid "参数优化起始点必须小于终止点"
msgstr ""
```

becomes

```
#: vnpy/trader/optimize.py:45
msgid "固定参数添加成功"
msgstr "Fixed parameters added successfully"

#: vnpy/trader/optimize.py:62
msgid "范围参数添加成功，数量{}"
msgstr "Range parameter added successfully, quantity {}"
```

See these projects for automation of the translation step:
* https://www.deepl.com/translator
* https://poeditor.com/
* https://www.transifex.com/

Quality of the automatic translation services is variable, and not always free. But they do at least provide a starting point. Sometimes a string will require a manual edit.

## binary files

The plain text languages files (*.po) must be converted into the binary format (.mo) used at runtime. This would be normally done at the build stage. But to do it manually during development or testing:

```shell
msgfmt -o vnpy/trader/locale/en/LC_MESSAGES/vnpy.mo vnpy/trader/locale/en/LC_MESSAGES/vnpy
```

## install

```shell
pip install . 
```

## execution

Now run the application, with your chosen language specified

```shell
LANG=en python vnpy/examples/veighna_trader/run.py 
```

or, set the environment variable `LANG` first, then run as normal. The  names 'LANGUAGE', 'LC_ALL', 'LC_MESSAGES' also work

## distribution

TBD
